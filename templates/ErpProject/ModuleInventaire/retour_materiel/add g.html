{% extends "ErpProject/ModuleInventaire/shared/layout.html" %}
{% block page %}
    <div class="row">
        <ul class="breadcrumb">
            <li><a><span class="mif-home"></span></a></li>
            <li><a class="chargement-au-click" href="{% url 'module_inventaire_tableau_de_bord' %}">Module Inventaire</a></li>
            <li><a class="leaf" href="{% url 'module_inventaire_list_transfert_internal' %}">Liste des Bons de Transfert</a></li>
            <li>{{ title }}</li>
        </ul>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <h2>{{title}}</h2>
            <strong style="float: right;color: grey;opacity: 0.4;margin-top: -30px;">{% now "jS F Y H:i" %}</strong>
            <div class="separ" style="background-color: grey;opacity: 0.2"></div>
            <div class="panel panel-default" style="border: none;">
    
                <div class="panel panel-body" style="background-color:#f5f5f5;border: none;border-radius: none;">
                    <div class="row">
                        <button onclick="javascript:enregistrer_bon()" class="button small-button rounded primary chargement-au-click primary_color_{{module.name|lower}}">Valider</button>
                        <button onclick="javascript:window.location.assign('{% url 'module_inventaire_list_transfert_internal' %}')" class="button small-button rounded" style="margin-left: 5px">Annuler</button>
                    </div>
                    <br>
                    <hr class="hr-ligne">
                    <!-- Appel de la fonction message -->
                        {% include 'ErpProject/ErpBackOffice/widget/message.html' with messages=messages only %}
                    <br>
                    

                    <form action="{% url 'module_inventaire_valider_transfert_internal' %}" method="POST"
                        data-role="validator" 
                        data-show-required-state="false"
                        data-hint-mode="line"
                        data-hint-background="bg-red"
                        data-hint-color="fg-white"
                        data-hide-error="5000"
                        novalidate="novalidate"
                        data-on-error-input="notifyOnErrorInput"
                        data-show-error-hint="false">
                        {% csrf_token %}
                        <input id="submit" type="submit" style="display: none">
                        <input id="nombreLigne" type="hidden" value="0" />
                        <div class="row">
                            <table class="table no-margin">
                                <tr>
                                    <td class="no-padding-top no-padding-left no-padding-bottom" width="35%">
                                        <label>Numéro de référence</label>
                                        <div class="input-control text full-size">
                                            <input type="text" id="numero" 
                                                data-validate-func="" 
                                                data-validate-hint="Entrez le numéro de référence svp." />
                                        </div>
                                    </td>
                                    <td  class="no-padding-top no-padding-bottom" width="35%">
                                        <label>Date prévue</label>
                                        <div id="input-date-prevue" class="input-control text full-size"  data-format="dd/mm/yyyy HH:MM" data-role="datepicker" data-locale="fr">
                                            <input readonly type="text" id="date_prevue" readonly
                                                data-validate-func="required" 
                                                data-validate-hint="Précisez la date prévue pour cette opération svp.">
                                            <div class="button"><span class="mif-calendar"></span></div>
                                        </div>
                                    </td>
                                    <td class="no-padding-top no-padding-bottom" width="30%"></td>
                                </tr>
                                <tr>
                                    <td class="no-padding-top no-padding-left no-padding-bottom" width="35%">
                                        <label>Type d'opérations</label>
                                        <div class="input-control text full-size">
                                            <select name="operation_stock_id" id="operation_stock_id" onchange="choix_operation_stock()"
                                                data-validate-func="min" 
                                                data-validate-arg="1"
                                                data-validate-hint="Sélectionnez l'operation à faire svp.">
                                                <option value="0">Sélectionnez une opération</option>
                                                {% for item in operations %}
                                                    <option value="{{ item.id }}"> {{ item.designation }} </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </td>
                                    <td class="no-padding-top no-padding-bottom" width="35%">
                                        <label>Document Exterieure</label>
                                        <div class="input-control text full-size">
                                            <input type="text" id="reference_document" 
                                                data-validate-func="">
                                        </div>
                                    </td>
                                    <td class="no-padding-top no-padding-bottom" width="30%"></td>
                                </tr>
                                <tr>
                                    <td class="no-padding-top no-padding-left no-padding-bottom" width="35%">
                                        <label>Emplacement d'origine</label>
                                        <div class="input-control text full-size">
                                            <select name="emplacement_origine_id" id="emplacement_origine_id" 
                                                onchange="choix_emplacement_origine()"
                                                data-validate-func="min" 
                                                data-validate-arg="1"
                                                data-validate-hint="Sélectionnez l'emplacement d'origine svp.">
                                                <option value="0">Sélectionnez un emplacement</option>
                                                {% for item in emplacements %}
                                                    <option value="{{ item.id }}"> {{ item.designation }} </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </td>
                                    <td class="no-padding-top no-padding-bottom" width="35%">
                                        <label>Emplacement de destination</label>
                                        <div class="input-control text full-size">
                                            <select name="emplacement_destination_id" id="emplacement_destination_id"
                                                data-validate-func="min" 
                                                data-validate-arg="1"
                                                data-validate-hint="Sélectionnez l'emplacement de destination svp.">
                                                <option value="0">Sélectionnez un emplacement</option>
                                                {% for item in emplacements %}
                                                    <option value="{{ item.id }}"> {{ item.designation }} </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </td>
                                    <td class="no-padding-top no-padding-bottom" width="30%"></td>
                                </tr>
                                <tr>
                                    <td class="no-padding-top no-padding-bottom" width="35%">
                                        <label>Alloué à :</label>
                                        <div class="input-control text full-size">
                                            <select name="demandeur_id" id="demandeur_id" 
                                                data-validate-func="min" 
                                                data-validate-arg="1"
                                                data-validate-hint="Sélectionnez l'operation à faire svp.">
                                                {% if etat_actuel_id == 0 %}
                                                    <option value="">Sélectionnez un employé</option>
                                                    {% for item in employee %}
                                                        <option value="{{ item.id }}"> {{ item.nom_complet }} </option>
                                                    {% endfor %}
                                                {% else %}
                                                    <option value="{{ etat.demandeur.id }}"> {{ etat.demandeur.nom_complet }} </option>
                                                {% endif %}
                                            </select>
                                        </div>
                                    </td>
                                    <td class="no-padding-top no-padding-bottom" width="35%">
                                        <label>Etat de besoin :</label>
                                        <div class="input-control text full-size">
                                            <select name="etat_besoin_id" id="etat_besoin_id" data-validate-func="min" data-validate-arg="1" data-validate-hint="Sélectionnez la catégorie svp.">
                                                {% if etat_actuel_id == 0 %}    
                                                    <option value="">Sélectionnez un état de besoin</option>
                                                    {% for item in etat_besoins %}
                                                        <option {% if etat_actuel_id == item.id %} {{ "selected" }} {% endif %} value="{{ item.id }}"> {{ item.numero_demande }} </option>
                                                    {% endfor %}
                                                {% else %}
                                                <option value="{{ etat.id }}"> {{ etat.numero_demande }} </option>
                                                {% endif %}
                                            </select>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <hr class="att-ligne" style="background-color: #4d4a4a; height:3px; margin-top:10px">
                        <div class="row margin20 no-margin-left no-margin-right">
                            <table class="table no-margin">
                                <thead class="no-border">
                                    <tr>
                                        <th class="no-padding-top no-padding-left no-padding-bottom" width="50%">Article</th>
                                        <th width="45%">Quantité </th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody id="items">
                                    <tr id="ligne1">
                                        <td class="no-padding-top no-padding-left no-padding-bottom">
                                            <input id="id1" type="hidden" value="0" />
                                            <input id="stock1" type="hidden" value="0" />
                                            <div class="input-control select full-size">
                                                <select class="article" onchange="selectChange(event)" id="item1"
                                                    data-validate-func="min" 
                                                    data-validate-arg="1"
                                                    data-validate-hint="Sélectionnez un article svp">
                                                    <option value="0">Sélectionnez un article</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td class="no-padding-top no-padding-bottom">
                                            <div class="input-control text full-size">
                                                <input id="quantite1" type="text" placeholder="Ex: 10"
                                                    data-validate-func="number" 
                                                    data-validate-hint="Précisez la quantité svp">
                                                <span class="prepend-icon" style="margin-left:75%">
                                                    <span style="margin-top: 1px;" id="unite1" class="sub-header place-right"></span>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="no-padding-top no-padding-bottom">
                                            <div class="pagination no-border">
                                                <span class="item" title="Supprimer la ligne" onclick="supprimerLigne(1)"><span class="mif-cross fg-red"></span></span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="row margin10 no-margin-left no-margin-right">
                            <button type="button" class="button small-button rounded" id="btnAjouterLigne">Ajouter une ligne</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="/static/ErpProject/js/transfert-local.js"></script>
    <script>
        var lesCategories = new Array();
        var lesArticles = new Array();
        var lesEmplacementsOrigine = new Array();
        var lesOperations = new Array();

        {% for item in categories %}
            lesCategories.push({id:"{{ item.id }}", designation:"{{ item.designation }}"});
        {% endfor %}

        {% for item in emplacements %}
            lesEmplacementsOrigine.push({id:"{{ item.id }}", designation:"{{ item.designation }}", type_emplacement:"{{ item.type_emplacement.designation }}"});
        {% endfor %}

        {% for item in operations %}
            lesOperations.push({id:"{{ item.id }}", designation:"{{ item.designation }}", reference:"{{ item.reference }}"});
        {% endfor %}
    </script>
    <script>
        var nombreLignes = 1;
        var nombreItems = 0;
        var ligneActuelle = 0;
        var compteur = 1;
        var bon = {};
        var on_ready = true;
    
        $(document).ready(function(){            
            bon = transfertLocal.avoirTransfert();

            if(bon != null)
            {
                $("#numero").val(bon.numero);
                $("#date_prevue").val(bon.date_prevue);
                $("#operation_stock_id").val(bon.operation_stock_id);
                $("#emplacement_origine_id").val(bon.emplacement_origine_id);
                $("#emplacement_destination_id").val(bon.emplacement_destination_id);
                $("#reference_document").val(bon.reference_document);
                $("#departement_id").val(bon.departement_id);
                $("#demandeur_id").val(bon.demandeur_id);

                choix_emplacement_origine();                
            }
        });
    
        $("#btnAjouterLigne").on("click", function () {
            nombreLignes++;
            compteur++;
            var nouvelleLigne = '<tr id="ligne' + compteur + '"><td class="no-padding-top no-padding-left no-padding-bottom">';
            nouvelleLigne += '<input id="id' + compteur + '" type="hidden" value="0" />';
            nouvelleLigne += '<input id="stock' + compteur + '" type="hidden" value="0" /><div class="input-control select full-size">';
            nouvelleLigne += '<select class="article" onchange="selectChange(event)" id="item' + compteur + '" data-validate-func="min"';
            nouvelleLigne += ' data-validate-arg="1" data-validate-hint="Sélectionnez un article"><option value="0">Sélectionnez un article</option>';
            nouvelleLigne += renvoyerOptionsArticles();
            nouvelleLigne += '</select></div></td>';
            nouvelleLigne += '<td class="no-padding-top no-padding-bottom"><div class="input-control text full-size">';
            nouvelleLigne += '<input id="quantite' + compteur + '" data-validate-func="number" ';
            nouvelleLigne += ' data-validate-hint="Précisez la quantité svp" type="text" placeholder="Ex: 10">';
            nouvelleLigne += '<span class="prepend-icon" style="margin-left:75%">';
            nouvelleLigne += '<span style="margin-top: 1px;" id="unite' + compteur + '" class="sub-header place-right"></span></span>';
            nouvelleLigne += '</div></td><td class="no-padding-top no-padding-bottom"><div class="pagination no-border">';
            nouvelleLigne += '<span class="item" title="Supprimer la ligne" onclick="supprimerLigne(' + compteur + ')"><span class="mif-cross fg-red"></span></span>';
            nouvelleLigne += '</div></td></tr>';
    
            $("#items").append(nouvelleLigne);
        });
        
        function choix_operation_stock()
        {
            var operation_stock_id = $("#operation_stock_id").val();
            if(operation_stock_id != "0")
            {
                for(var i = 0; i < lesOperations.length; i++)
                {
                    var operation = lesOperations[i];
                    if(operation.id == operation_stock_id && operation.reference == "IN")
                    {
                        for(var j = 0; j < lesEmplacementsOrigine.length; j++)
                        {
                            var emplacement = lesEmplacementsOrigine[j];
                            if(emplacement.type_emplacement == operation.reference)
                            {
                                $("#emplacement_origine_id").val(emplacement.id);
                                break;
                            }
                        }
                        break;
                    }
                    else $("#emplacement_origine_id").val("0");
                }
            }
        }

        function choix_emplacement_origine()
        {
            var emplacement_id = $("#emplacement_origine_id").val();
            if(emplacement_id != "0")
            {
                $.get(
                    "{% url 'module_inventaire_list_articles_emplacement' %}",
                    {ref: emplacement_id},
                    function(data)
                    {
                        lesArticles = new Array();
                        for(var i = 0; i < data.length; i++)
                        {
                            var article = data[i];
                            lesArticles.push(article);
                        }
                        chargerArticles();
                        if(on_ready == true)
                        {
                            var lignes = transfertLocal.avoirToutesLignes();
                            if(lignes.length != 0)
                            {
                                for(var i = 0; i < lignes.length; i++)
                                {
                                    var item = lignes[i];
                                    var k = i + 1;
                                    if(k == 1)
                                    {
                                        $("#item1").val(item.article_id);
                                        $("#stock1").val(item.stock_article_id);
                                        $("#quantite1").val(item.quantite_demandee);
                                        $("#id1").val(item.ligne_id);
                                        $("#unite1").text(item.symbole_unite);
                                    }
                                    else
                                    {
                                        nombreLignes++;
                                        compteur++;
                                        var nouvelleLigne = '<tr id="ligne' + compteur + '"><td class="no-padding-top no-padding-left no-padding-bottom">';
                                        nouvelleLigne += '<input id="id' + compteur + '" type="hidden" value="' + item.ligne_id  + '" />';
                                        nouvelleLigne += '<input id="stock' + compteur + '" type="hidden" value="' + item.stock_article_id  + '" /><div class="input-control select full-size">';
                                        nouvelleLigne += '<select class="article" onchange="selectChange(event)" id="item' + compteur + '" data-validate-func="min"';
                                        nouvelleLigne += ' data-validate-arg="1" data-validate-hint="Sélectionnez un article">';
                                        nouvelleLigne += '<option value="0">Sélectionnez un article</option>';
                                        nouvelleLigne += renvoyerOptionsArticles();
                                        nouvelleLigne += '</select></div></td>';
                                        nouvelleLigne += '<td class="no-padding-top no-padding-bottom"><div class="input-control text full-size">';
                                        nouvelleLigne += '<input id="quantite' + compteur + '" value="' + item.quantite_demandee  + '" data-validate-func="number"';
                                        nouvelleLigne += ' data-validate-hint="Précisez la quantité svp" type="text" placeholder="Ex: 10">';
                                        nouvelleLigne += '<span class="prepend-icon" style="margin-left:75%">';
                                        nouvelleLigne += '<span style="margin-top: 1px;" id="unite' + compteur + '" class="sub-header place-right">' + item.symbole_unite  + '</span></span>';
                                        nouvelleLigne += '</div></td><td class="no-padding-top no-padding-bottom"><div class="pagination no-border">';
                                        nouvelleLigne += '<span class="item" title="Supprimer la ligne" onclick="supprimerLigne(' + compteur + ')"><span class="mif-cross fg-red"></span></span>';
                                        nouvelleLigne += '</div></td></tr>';
                    
                                        $("#items").append(nouvelleLigne);
                                    }
                                }
                                for(var i = 1; i < lignes.length; i++)
                                {
                                    var item = lignes[i];
                                    var k = i + 1;
                                    $("#item" + k).val(item.article_id);
                                }
                            }
                            on_ready = false;
                        }
                    },
                    "json"
                );
            }
            else
            {
                $(".article").children().remove();
                $(".article").append('<option value="0">Sélectionnez un article</option>');
            }
        }

        function chargerArticles()
        {
            $(".article").children().remove();
            $(".article").append('<option value="0">Sélectionnez un article</option>');

            for(var i = 0; i < lesCategories.length; i++)
            {
                var categorie = lesCategories[i];
                var hasArticle = "0";
                for(var j = 0; j < lesArticles.length; j++)
                {
                    var article = lesArticles[j];
                    if(article.categorie_id == categorie.id)
                    {
                        hasArticle = "1";
                        break;
                    }
                }
                if(hasArticle == "1")
                {
                    var ligne = '<optgroup label="' + categorie.designation + '">';
                    for(var j = 0; j < lesArticles.length; j++)
                    {
                        var article = lesArticles[j];
                        if(article.categorie_id == categorie.id)
                        {
                            ligne += '<option value="' + article.id + '">' + article.designation + '</option>';
                        }
                    }
                    ligne += '</optgroup>';
                    $(".article").append(ligne);
                }
            }
        }
    
        function selectChange(event)
        {
            $select = $(event.target); 
            var id_element = $select[0].id; //window.location.assign(""); //window.location.reload(true)
            console.log("ID ELEMENT : " + id_element);
            if(id_element.substring(0, 4) == "item")
            {
                ligneActuelle = $select[0].id.substr($select[0].name.length - 1, 1);
    
                if($("#" + id_element).val() != "0")
                {
                    nombreItems += 1;
                    var idArticle = parseInt($("#" + id_element).val());
                    console.log("Cod_Article= " + idArticle);
                    $.get(
                        "{% url 'module_achat_details_article_fourni' %}",
                        {ref : idArticle},
                        function(data)
                        {
                            if(data != null)
                            {
                                $("#quantite" + ligneActuelle).val(1);
                                $("#unite" + ligneActuelle).text(data.symbole_unite);
                            }
                        },
                        "json"
                    );
                }
                else nombreItems -= 1;
            }
        }

        function supprimerLigne(indice) {
            nombreLignes--;
            if($("#id" + indice).val() != "0")
            {
                transfertLocal.supprimerLigne($("#id" + indice).val());
            }
            $("#ligne" + indice).remove();
        }

        function enregistrer_bon(){
            var canPost = true;
            var ordre = {
                numero : "",
                date_prevue : "",
                operation_stock_id : 0,
                emplacement_origine_id : 0,
                emplacement_destination_id : 0,
                departement_id : 0,
                demandeur_id : 0,
                reference_document : ""
            };
            var items = new Array();
    
            for(var i = 1; i <= compteur; i++)
            {
                var ligneOperation = document.getElementById("item" + i);
                if(ligneOperation != null)
                {
                    var item = {
                        ligne_id : new Date().getTime() + "-" + i,
                        article_transfert_id : 0,
                        nom_article : "",
                        stock_article_id : 0,
                        quantite_demandee : 0,
                        quantite_fournie : 0,
                        symbole_unite : "",
                        type : "ligne-transfert"
                    };
                    if($("#id" + i).val() != "0") item.ligne_id = $("#id" + i).val();
    
                    if($("#item" + i).val() != "0") 
                    {
                        item.article_id = $("#item" + i).val();
    
                        for(var k = 1; k < $("#item" + i).children().length; k++)
                        {
                            var found = false;
                            var optGroup = $($("#item" + i).children()[k]);
                            for(var j = 0; j < optGroup.children.length; j++)
                            {
                                var option = $(optGroup.children()[j]);
                                if(item.article_id == option.val())
                                {
                                    item.nom_article = option.text();
                                    found = true;
                                    break;
                                }
                            }
                            if(found == true) break;
                        }
                    }
                    else
                    {
                        canPost = false;
                        break;
                    }
    
                    var quantite = $("#quantite" + i).val();
                    if(!((quantite - 0) == quantite && ('' + quantite).trim().length > 0))
                    {
                        canPost = false;
                        break;
                    }
                    else item.quantite_demandee = quantite;

                    item.symbole_unite = $("#unite" + i).text();
                    items.push(item);
                }
            }
                
            if($("#numero").val().length == 0) canPost = false;
            else ordre.numero = $.trim($("#numero").val());

            if($("#date_prevue").val().length == 0) canPost = false;
            else ordre.date_prevue = $("#date_prevue").val();

            if($("#operation_stock_id").val() == "0") canPost = false;
            else ordre.operation_stock_id = $("#operation_stock_id").val();

            if($("#emplacement_origine_id").val() == "0") canPost = false;
            else ordre.emplacement_origine_id = $("#emplacement_origine_id").val();

            if($("#emplacement_destination_id").val() == "0") canPost = false;
            else ordre.emplacement_destination_id = $("#emplacement_destination_id").val();

            if($("#departement_id").val() == "0") canPost = false;
            else ordre.emplacement_destination_id = $("#departement_id").val();

            if($("#demandeur_id").val() == "0") canPost = false;
            else ordre.emplacement_destination_id = $("#demandeur_id").val();
            
            ordre.reference_document = $("#reference_document").val();
            if(canPost == true)
            {
                $.each(items, function(i, ligne){
                    transfertLocal.ajouterLigneTransfert(ligne);
                });
                transfertLocal.ajouterTransfert(ordre);
            }
            document.getElementById('submit').click();
        }
    
        function renvoyerOptionsArticles()
        {
            var ligne = "";
            var hasArticle = "0";
            for(var i = 0; i < lesCategories.length; i++)
            {
                var categorie = lesCategories[i];
                for(var j = 0; j < lesArticles.length; j++)
                {
                    var article = lesArticles[j];
                    if(article.categorie_id == categorie.id)
                    {
                        hasArticle = "1";
                        break;
                    }
                }
                if(hasArticle == "1")
                {
                    ligne += '<optgroup label="' + categorie.designation + '">';
                    for(var j = 0; j < lesArticles.length; j++)
                    {
                        var article = lesArticles[j];
                        if(article.categorie_id == categorie.id)
                        {
                            ligne += '<option value="' + article.id + '">' + article.designation + '</option>';
                        }
                    }
                    ligne += '</optgroup>';
                }
            }
            return ligne;
        }
    </script>
{% endblock %}