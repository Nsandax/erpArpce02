{% extends "ErpProject/ModuleBudget/shared/layout.html" %} {% block page %}
{%load static %}
{% load account_filters %}
<link rel="stylesheet" href="{% static 'ErpProject/css/bootstrap-chosen.css' %}">

<script src="{% static 'ErpProject/js/chosen.jquery.js' %}"></script>

<div class="row">
    <ul class="breadcrumb">
        <li><a><span class="mif-home"></span></a></li>
        <li><a class="chargement-au-click" href="{% url 'module_budget_tableau_de_bord' %}">Module Budget</a></li>
        <li>{{ title }}</li>
    </ul>
</div>

        <br>
        <div class="row">
            {% for item in model %}
            <div class="col-md-3">

                <div class="card-item">
                    <div class="card-item-content">
                        <div class="thumb">
                            <img class="card-img-top" src="{% static 'ErpProject/icons/achats.png' %}" style="width:70px;height:70px;padding-top: 5px" alt="Card image">
                        </div>
                        <div class="texts">
                            <h1 class="inner-text" >{{ item.designation }}</h1>
                            <h1 class="inner-text">{{ item.created_at|date:"H:m à d M Y " }}</h1>
                            <h1 class="inner-text">{{ item.montant |monetary }} {{item.devise.symbole_devise}}</h1>
                            <a onclick="traiterRapprochement('{{item.id}}')" style="color: white" class="mt-3">
                                <center>
                                        <h6 style="font-size: 15px;font-weight: 100" class="slide-over bg-red padding10">
                                            Traiter
                                        </h6>
                                </center>
                            </a>


                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

<!-- Billeterie -->
<div data-role="dialog" data-close-button="true" data-overlay="true" data-overlay-color="op-dark" data-overlay-click-close="false" id="dialogBillet">

    <div class="row cells3 padding20" style="margin-top: 10px">
        <h3>Rapprochement</h3>
        <h4 id="headerTransaction">Liste des lignes de bons de commande en attende de facturation correspondant au montant de la transaction seléctionnée</h4>
        <div class="cells2">
            <div id="formBilleterie" >

                <div class="row margin20 no-margin-left no-margin-right">
                    <table id="tableau_billeterie" class="table no-margin">
                        <thead class="no-border">
                            <tr>
                                <th width="20%">Numero bon</th>
                                <th width="15%">Article</th>
                                <th width="20%">Ligne budgétaire</th>
                                <th width="15%">Montant total</th>
                                <th width="30%">Date</th>
                                <th width="5%"></th>

                            </tr>
                        </thead>
                        <tbody id="itemLigneBudget">



                        </tbody>
                    </table>

                <hr style="background-color: #f7f5f5;">
                <div class="row">
                    <!--button class="button small-button rounded" onclick="closeDialog('#dialogBillet')" style="margin-left: 5px">Annuler</!--button-->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Fin B -->

<script>


    function traiterRapprochement(item_id){
              $.get(
                    "{% url  'module_budget_get_lignes_bon_commande_non_facture_by_transaction' %}",
                    {ref: item_id},
                    function(response)
                    {
                        if(response != null)
                        {
                            $("#itemLigneBudget").children().remove();
                            var txt = "";
                            for (var i = 0; i < response.length; i++) {
                            var data  = response[i];
                                // On affiche que les lignes dont le montant correspond
                                txt +='<tr><td class="no-padding-top no-padding-left no-padding-bottom">'
                                txt += '<div class=" input-control text full-size">'
                                txt += '<input type="text" readonly value="' + data.numero_bon + '"></div></td>'
                                txt +='<td class="no-padding-top no-padding-left no-padding-bottom">'
                                txt += '<div class=" input-control text full-size">'
                                txt += '<input type="text" readonly value="' + data.article + '"></div></td>'
                                txt +='<td class="no-padding-top no-padding-left no-padding-bottom">'
                                txt += '<div class=" input-control text full-size">'
                                txt += '<input type="text" readonly value="' + data.ligne_budgetaire + '"></div></td>'
                                txt +='<td class="no-padding-top no-padding-left no-padding-bottom">'
                                txt += '<div class=" input-control text full-size">'
                                txt += '<input type="text" readonly value="' + data.montant_total + ' ' + data.devise + '"></div></td>'
                                txt +='<td class="no-padding-top no-padding-left no-padding-bottom">'
                                txt += '<div class=" input-control text full-size">'
                                txt += '<input type="text"  readonly value="' + data.date + '"></div></td>'
                                txt += '<td class="no-padding-top no-padding-bottom">'
                                txt += ' <div class="pagination no-border">'
                                txt += `<button class="button small-button bg-green rounded primary chargement-au-click" onclick="rapprocherTransaction('` + item_id + ` ',` + data.id + `)">Sélectionner</button>`;






                            }
                            if (response.length == 0){
                                txt += '<tr><td colspan="5">Aucune ligne de bon de commande ayant le même montant trouvé!</td><tr>';
                            }
                            $("#itemLigneBudget").append(txt);

                        }
                    },
                    "json"
                );
                var dialog = $("#dialogBillet").data('dialog');
	            dialog.open();

    }

    function rapprocherTransaction(transaction_id, ligne_reception_id){

        console.log(transaction_id, ligne_reception_id)


        Swal.fire({
                title: 'Confirmez-vous?',
                text: "Le rapprochement de la transaction séléctionnée ?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Oui, je confirme!'
            }).then((result) => {
                if (result.value) {
                    console.log("Lllllllllllllllllllllllllla")
                    $.get(
                            "{% url  'module_budget_post_rapprochement_transaction' %}",
                            {transaction_id : transaction_id, ligne_reception_id: ligne_reception_id},
                            function(response)
                            {
                                if(response != null)
                                {
                                    if (response.is_success) {
                                        Swal.fire({
                                                title: 'Succès',
                                                text: "Rapprochement réussi",
                                                icon: 'success',
                                        }).then((result) => {location.reload();})
                                    }else{
                                        Swal.fire({
                                                title: 'Echec',
                                                text: "Rapprochement echoué",
                                                icon: 'error',
                                        }).then((result) => {location.reload();})
                                    }
                                }
                            },
                            "json"
                        );
                }
            })

    }






</script>

{% endblock %}