{% extends "ErpProject/ModuleComptabilite/shared/layout.html" %}
{% block page %}
    <div class="row">
        <ul class="breadcrumb">
            <li><a><span class="mif-home"></span></a></li>
            <li><a class="chargement-au-click" href="{% url 'module_comptabilite_tableau_de_bord' %}">Module Comptabilité</a></li>
            <li>{{ title }}</li>
        </ul>
    </div>
    <div class="row">
        <div class="col-lg-12">
        <h2>{{ title }}</h2>
        <strong style="float: right;color: grey;opacity: 0.85;margin-top: -30px;">{% now "jS F Y H:i" %}</strong>
            <div class="separ" style="background-color: grey;opacity: 0.2"></div>
            <div class="panel panel-default" style="border: none;">            
                <div class="panel panel-body" style="background-color:#f5f5f5;border: none;border-radius: none;">
                    <div class="row">
                        <button onclick="enregistrer_piece()" class="theme-btn theme-btn-sm rounded primary_color_{{module.name|lower}} chargement-au-click">Créer</button> 
                        <button onclick="javascript:window.location.assign('{% url 'module_comptabilite_upload_ouverture_compte' %}')" class="theme-btn theme-btn-sm rounded chargement-au-click">Importer un excel</button>
                    </div>
                    <hr class="hr-ligne">
                    <!-- Appel de la fonction message -->
                        {% include 'ErpProject/ErpBackOffice/widget/message.html' with messages=messages only %}
                    <br>
                    <table id="example" class="display nowrap border bordered striped" cellspacing="0" style="width:100%">
                        <thead>
                            <tr>
                                <th width="15%">Numéro</th>
                                <th width="46%">Désignation</th>
                                <th width="17%">Débit d'ouverture</th>
                                <th width="17%">Crédit d'ouverture</th>
                                <th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in model %} 

                                <tr id="compte_{{ item.id }}" data-updated="false">
                                    <input name="compte_id" type="hidden" value="{{ item.id }}">
                                    <td> 
                                        <a class="lien chargement-au-click" href="{% url 'module_comptabilite_details_compte' item.id %}">{{ item.numero }}</a> 
                                    </td>
                                    <td> 
                                        {{ item.designation }} 
                                    </td>
                                    <td> 
                                        <div class="input-control text full-size">
                                            <input id="valeur_debit{{ item.id }}" name="valeur_debit" type="text" value="{{ item.valeur_debit }}" disabled="true" onchange="soldeModifie(this)" data-id="{{ item.id }}">
                                        </div>
                                    </td>
                                    <td> 
                                        <div class="input-control text full-size">
                                            <input id="valeur_credit{{ item.id }}" name="valeur_credit" type="text" value="{{ item.valeur_credit }}" disabled="true" onchange="soldeModifie(this)" data-id="{{ item.id }}">
                                        </div>
                                    </td>
                                    <td class="no-padding-top no-padding-bottom">
                                        <div class="pagination no-border">
                                            <span class="item" title="Modifier le solde ce compte" onclick="modifierSolde({{ item.id }})"><span class="mif-pencil fg-gray"></span></span>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <br><br>
                    <hr class="att-ligne" style="background-color: #4d4a4a; height:3px; margin-top:10px">
                    <div class="row margin20 no-margin-left no-margin-right">
                        <h3>Pour les Nouveaux comptes ...</h3>                       
                        <form id="form" method="POST" action="{% url 'module_comptabilite_post_add_ouverture_compte' %}" enctype="multipart/form-data" data-role="validator" data-show-required-state="false" data-hint-mode="line" data-hint-background="bg-red" data-hint-color="fg-white" data-hide-error="5000"
                            novalidate="novalidate" data-on-error-input="notifyOnErrorInput" data-show-error-hint="false">
                            {% csrf_token %}
                            <input id="submit" type="submit" style="display: none">
                            <!-- Pour les comptes qui existent déjà -->
                            <div id="ancien_items">
                            </div>   
                            <!-- Pour les nouveaux comptes  -->
                            <table class="table no-margin">
                                <thead class="no-border">
                                    <tr>
                                        <th width="15%">Numéro</th>
                                        <th width="46%">Désignation</th>
                                        <th width="17%">Débit d'ouverture</th>
                                        <th width="17%">Crédit d'ouverture</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody id="items">
                                    <tr id="ligne1">
                                        <td class="no-padding-top no-padding-bottom">
                                            <div class="input-control text full-size">
                                                <input id="numero1" name="numero" type="text"
                                                    data-validate-func="required"
                                                    data-validate-hint="Entrez le numéro du compte svp">
                                            </div>
                                        </td>
                                        <td class="no-padding-top no-padding-bottom">
                                            <div class="input-control text full-size">
                                                <input id="designation1" name="designation" type="text"
                                                    data-validate-func="required"
                                                    data-validate-hint="Entrez la désignation du compte svp">
                                            </div>
                                        </td>
                                        <td class="no-padding-top no-padding-bottom">
                                            <div class="input-control text full-size">
                                                <input class="monetary" id="montant_debit1" name="montant_debit" onchange="soldeNouveauModifie(this)" data-id="1" type="text" placeholder="Ex: 100" value="0">
                                            </div>
                                        </td>
                                        <td class="no-padding-top no-padding-bottom">
                                            <div class="input-control text full-size">
                                                <input class="monetary" id="montant_credit1" name="montant_credit" onchange="soldeNouveauModifie(this)" data-id="1" type="text" placeholder="Ex: 100" value="0">
                                            </div>
                                        </td>
                                        <td class="no-padding-top no-padding-bottom">
                                            <div class="pagination no-border">
                                                <span class="item" title="Supprimer la ligne" onclick="supprimerLigne(1)"><span class="mif-cross fg-red"></span></span>
                                            </div>
                                        </td>
                                        <input id="compte_id1" name="compte_id" value="0" type="hidden">
                                    </tr>
                                </tbody>
                            </table>
                        </form>
                    </div>
                    <div class="row margin10 no-margin-left no-margin-right">
                        <button type="button" class="button small-button rounded" id="btnAjouterLigne">Ajouter une ligne</button>
                    </div>

                </div>
            </div>
        </div>
        <!-- /.col-lg-12 -->
    </div>   
    <script>
        var items = new Array();
        var lesComptes = new Array();  

        {% for item in model %}
            //lesComptes.push({id:"{{ item.id }}", designation:"{{ item.numero }} {{ item.designation }}", valeur_debit:"{{ item.valeur_debit }}", valeur_credit:"{{ item.valeur_credit }}",});
            var debit = parseFloat("{{ item.valeur_debit }}");
            var credit = parseFloat("{{ item.valeur_credit }}");
            var id = "{{ item.id }}";
            var solde = debit - credit;
            /*$("#valeur_debit"+id).val();
            $("#valeur_credit"+id).val();*/
            if (solde != 0){
                var item = {
                    id : 0,
                    montant_credit : 0,
                    montant_debit : 0,
                };
                item.id = id;
                item.montant_credit = credit;
                item.montant_debit = debit;
                items.push(item);
            }
        {% endfor %}

        var nombreLignes = 1;
        var compteur = 1;

        $("#btnAjouterLigne").on("click", function () {
            nombreLignes++;
            compteur++;
            var nouvelleLigne = '<tr id="ligne' + compteur + '">';
            nouvelleLigne += '<td class="no-padding-top no-padding-bottom"><div class="input-control select full-size">'
            nouvelleLigne += '<input name="numero" id="numero' + compteur + '" type="text" data-validate-func="required" data-validate-hint="Entrez le numéro du compte svp"></div></td>';

            nouvelleLigne += '<td class="no-padding-top no-padding-bottom"><div class="input-control select full-size">';
            nouvelleLigne += '<input name="designation" id="designation' + compteur + '" type="text" data-validate-func="required" data-validate-hint="Entrez le numéro du compte svp"></div></td>';
            
            nouvelleLigne += '<td class="no-padding-top no-padding-bottom"><div class="input-control text full-size">';
            nouvelleLigne += '<input class="monetary" name="montant_debit" id="montant_debit' + compteur + '" onchange="soldeNouveauModifie(this)" data-id="' + compteur + '" type="text" value="0.00" placeholder="Ex: 100"></div></td>';

            nouvelleLigne += '<td class="no-padding-top no-padding-bottom"><div class="input-control text full-size">';
            nouvelleLigne += '<input class="monetary" name="montant_credit" id="montant_credit' + compteur + '" onchange="soldeNouveauModifie(this)" data-id="' + compteur + '" type="text" value="0.00" placeholder="Ex: 100"></div></td>';

            nouvelleLigne += '<td class="no-padding-top no-padding-bottom"><div class="pagination no-border">';
            nouvelleLigne += '<span class="item" title="Supprimer la ligne" onclick="supprimerLigne(' + compteur + ')"><span class="mif-cross fg-red"></span></span>';
            nouvelleLigne += '</div></td><input id="compte_id' + compteur + '" name="compte_id" value="0" type="hidden"></tr>';
    
            $("#items").append(nouvelleLigne);
        });

        function supprimerLigne(indice) {
            nombreLignes--;           
            $("#ligne" + indice).remove();
        }
    </script>    
    <script>
        function modifierSolde(indice) {
            //console.log("modifierSolde");
            $("#valeur_credit" + indice).removeAttr('disabled');
            $("#valeur_debit" + indice).removeAttr('disabled');
            //console.log("#compte_" + indice + " : " + $("#compte_" + indice).data('updated'));
            $("#compte_" + indice).data('updated', true);
            //console.log("#compte_" + indice + " : " + $("#compte_" + indice).data('updated'));
        }
        function soldeModifie(input) {
            var debit = 0.00;
            var credit = 0.00;
            var name = input.name;
            var value = floatVal(input.value);
            var css_id = input.id;
            var id = $("#"+css_id).data('id');

            console.log("soldeModifie");
            console.log("name: "+ name +", value: "+ value +", css id: "+ css_id +", id: "+ id);

            if(isNaN(value))
            {
                $.Notify({
                    caption: 'Erreur',
                    content: input.value + " n'est pas un nombre, Entrez un nombre valide SVP",
                    type: 'alert'
                });
                $("#"+css_id).val("0.00");
                return;
            } else { 
                if (name == "valeur_debit"){
                    debit = value;
                    $("#"+css_id).val(value);
                    $("#valeur_credit" + id).val("0.00");
                } else {
                    credit = value;
                    $("#"+css_id).val(value);
                    $("#valeur_debit" + id).val("0.00");
                }
                console.log("credit: "+ credit +", debit: "+ debit);
                console.log("nombre items: "+ items.length);
                var existe = false;
                for(var i=0; i < items.length; i++){
                    var compte = items[i];
                    if (compte.id == id){
                        existe = true;
                        compte.montant_credit = credit;
                        compte.montant_debit = debit;
                    }                
                }
                if (!existe){
                    var item = {
                        id : 0,
                        montant_credit : 0,
                        montant_debit : 0,
                    };
                    item.id = id;
                    item.montant_credit = credit;
                    item.montant_debit = debit;
                    items.push(item);
                }
                console.log("nombre items après modif: "+ items.length);               
            }
        }
        function soldeNouveauModifie(input) {
            var name = input.name;
            var value = floatVal(input.value);
            var css_id = input.id;
            var id = $("#"+css_id).data('id');
            var debit = 0.00;
            var credit = 0.00;

            console.log("soldeNouveauModifie");
            console.log("name: "+ name +", value: "+ value );

            if(isNaN(value))
            {
                $.Notify({
                    caption: 'Erreur',
                    content: input.value + " n'est pas un nombre, Entrez un nombre valide SVP",
                    type: 'alert'
                });
                $("#"+css_id).val("0.00");
                return;
            }else{
                if (name == "montant_debit"){
                    debit = value;
                    $("#"+css_id).val(value);
                    $("#montant_credit" + id).val("0.00");
                } else {
                    credit = value;
                    $("#"+css_id).val(value);
                    $("#montant_debit" + id).val("0.00");
                } 
                console.log("credit: "+ credit +", debit: "+ debit);               
            }
        }
    </script> 
    <script>
        function enregistrer_piece(){
            $("#ancien_items").children().remove();
            var ecritures = new Array();
            var canPost = true;
            console.log("Enregistrer Piece");
            console.log("items: "+ items.length);
            console.log("ecritures avant: "+ ecritures.length);

            for(var i = 0; i < items.length; i++){ ecritures.push(items[i]); }

            console.log("ecritures apres: "+ ecritures.length);
            console.log("items apres: "+ items.length);

            //On verifie et récupère les données des comptes mouvementés
            for(var i = 0; i < ecritures.length; i++)
            {
                var compte = ecritures[i];
                var debit = compte.montant_debit;
                var credit = compte.montant_credit;
                console.log("compte: " + compte.id);
                              
                var nouvelleLigne = '<input id="ancien_compte_id' + compte.id + '"name="compte_id" value="' + compte.id + '" type="hidden">';
                nouvelleLigne += '<input id="ancien_numero' + compte.id + '"name="numero" value="-" type="hidden">'; 
                nouvelleLigne += '<input id="ancien_designation' + compte.id + '"name="designation" value="-" type="hidden">'; 
                nouvelleLigne += '<input id="ancien_montant_debit' + compte.id + '"name="montant_debit" value="' + debit + '" type="hidden">'; 
                nouvelleLigne += '<input id="ancien_montant_credit' + compte.id + '"name="montant_credit" value="' + credit + '" type="hidden">';
                $("#ancien_items").append(nouvelleLigne);               
            }
            console.log("fin données anciens");
            console.log("compteur :" + compteur);
            //Puis On verifie et récupère les données des nouveaux comptes
            for(var i = 1; i <= compteur; i++)
            {
                console.log("début données nouveau");
                var ligneEcriture = document.getElementById("ligne" + i);
                if(ligneEcriture != null)
                {
                    var debit = floatVal($("#montant_debit" + i).val());
                    var credit = floatVal($("#montant_credit" + i).val());

                    if(isNaN(credit) || isNaN(debit))
                    {
                        canPost = false;
                        break;
                        $.Notify({
                            caption: 'Erreur',
                            content: "Entrez un nombre valide SVP",
                            type: 'alert'
                        });
                        return;
                    }
                    var solde = debit - credit;
                    console.log("solde "+ solde);
                    if (solde != 0){
                        var item = {
                            montant_credit : 0,
                            montant_debit : 0,
                        };
                        item.montant_credit = credit;
                        item.montant_debit = debit;
                        ecritures.push(item);
                    }
                }
            }
            console.log("fin données nouveau");

            if(canPost == true)
            {
                var total_debit = 0; var total_credit = 0;
                for(var i = 0; i < ecritures.length; i++)       
                {
                    var ecriture = ecritures[i];
                    total_credit += ecriture.montant_credit;
                    total_debit += ecriture.montant_debit;
                }
                console.log("total_credit: " + total_credit);
                console.log("total_debit: " + total_debit);

                console.log("ecritures apres: "+ ecritures.length);
                console.log("items apres: "+ items.length);
                
                if(total_credit !== total_debit)
                {
                    $.Notify({
                        caption: 'Erreur',
                        content: "La pièce doit être équilibrée au niveau des écritures comptables",
                        type: 'alert'
                    });
                    canPost = false;
                    return;
                }
            }
            if(canPost == true) {
                document.getElementById('submit').click();
                console.log("canPost");
            }else{
                $.Notify({
                    caption: 'Erreur',
                    content: "Erreur survenue au moment de la validation, vérifier si les montant entrés sont corrects",
                    type: 'alert'
                });                
            }
        }
    </script>
    <script>
        $(document).ready(function() {
            $('#example').DataTable( {
                dom: 'Bfrtip',
                buttons: []
            } );
        } );
        function floatVal(char){
            floatValue = parseFloat(char.trim().replace(',', '.').replace(/\s/g, ''))
            return floatValue;
        }
    </script>
{% endblock %}