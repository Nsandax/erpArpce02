{% extends "ErpProject/ModuleComptabilite/shared/layout.html" %} {% block page %}
    {% load account_filters %}{% load humanize %}
    <div class="row">
        <ul class="breadcrumb">
            <li><a><span class="mif-home"></span></a></li>
            <li><a class="chargement-au-click" href="{% url 'module_comptabilite_tableau_de_bord' %}">Module Comptabilité</a></li>
            <li><a class="chargement-au-click" href="{% url 'module_comptabilite_list_factures_client' %}">Liste des factures clients</a></li>
            <li>{{ title }}</li>
        </ul>
    </div>

    <div class="row" style="padding-top: 30px;">
        <div class="col-lg-12">
            <h2>{{ title }}</h2>
            <strong style="float: right;color: grey;opacity: 0.4;margin-top: -30px;">Le {% now " d/m/Y H:i" %}</strong>
            <div class="separ" style="background-color: grey;opacity: 0.2"></div>

            <!-- GESTION DU WORKFLOW -->
            {% include 'ErpProject/ErpBackOffice/widget/workflow.html' with utilisateur=utilisateur model=model content_type_id=content_type_id historique=historique roles=roles etapes_suivantes=etapes_suivantes url_add="module_comptabilite_add_facture_client" url_detail="module_comptabilite_details_facture_client" csrf_token=csrf_token module=module type_doc="Facture client" only %}
            <!--FIN GESTION DU WORKFLOW-->
            <div class="separ" style="background-color: grey;opacity: 0.2"></div>
            <br>
            <div class="panel panel-default" style="border: none;">
                <div class="panel panel-body" style="background-color:white;">
                    <div class="row">
                        {% if model.statut.designation == "Accusé de reception téléchargée" %}
                            {% if not is_solded %}
                                <button onclick="javascript:window.location.assign('{% url 'module_comptabilite_add_paiement_facture_client' model.id %}')" class="button small-button rounded primary chargement-au-click">Ajouter un paiement</button>
                            {% endif %}
                       {% endif %}
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-6">
                            <h2>ARPCE</h2>
                        </div>
                        <div class="col-md-6" style="text-align: right;">
                            <h4><strong>Facture du client</strong></h4>
                            <!-- <form  method="POST" action="{% url 'module_comptabilite_print_facture_client' %}">
                                {% csrf_token %}
                                <input type="hidden" name="id" value={{model.id}}> -->
                                <button type="submit" onclick="imprimer({{model.id}})" class="btn btn-default" style="background-color: #41435d;border:none;color: white;" >Imprimer</button>
                            <!-- </form> -->

                            <h3 style="color: red; font-weight: bold">
                                {% if model.numero_facture != None and model.numero_facture != "" %}
                                    <span class="fg-dark">N° {{ model.numero_facture }}</span>
                                {% else %}
                                    <span class="sub-alt-header fg-dark">N°  --</span>
                                {% endif %}
                            </h3>
                            <br><span style="font-weight: bold"class="fg-dark">N° Séquence {{ model.id }}</span>
                        </div>
                        <div class="separ col-md-12" style="background-color: grey;opacity: 0.1;margin-bottom: 20px;"></div>
                        <div class="col-md-6">
                            <p style="">
                                <strong>Nom du client : </strong>{{model.client.nom_complet}}<br>
                                <strong>Tél/Fax:</strong>  {{model.client.phone}}<br>
                                <strong>Email: </strong> {{model.client.email}} <br/>
                                <strong>Pays: </strong> Brazzaville, R. Congo<br>
                                <strong>Adresse: </strong> {{model.client.adresse_complete}}<br>
                            </p>
                        </div>
                        <div  class="col-md-6" style="margin-bottom: 40px">
                            <p style="float: right;">
                                <strong>Date facturation: </strong>{{model.date_facturation | date:"d/m/Y" }} <br>
                                <strong>Statut de la facture : </strong> {{model.statut.designation}} <br>
                                <strong>Ligne budgetaire : </strong>{{bon.ligne_budgetaire.designation}} <br>
                                <strong>Modalité de réglement : </strong>{{bon.condition_reglement.designation}}<br>
                                <strong>Type de service : </strong> {{model.type_service.designation}} <br>
                                <strong>Autres informations : </strong> {{model.autres_infos}} <br>
                            </p>
                        </div>
                        <div class="col-md-12"><br><br><br></div>
                        <div class="col-md-12" >
                            <table class="display nowrap border bordered striped" cellspacing="0" style="width: 100%;" >
                                <thead>
                                    <td class="head">Désignation</td>
                                    <td class="head">Quantité</td>
                                    <td class="head">Prix unitaire</td>
                                    <td class="head">Montant</td>
                                </thead>

                                {% for ligne in lignes %}
                                    <tr class="table bordered border">
                                        <td class="td">{{ ligne.nom_article}}</td>
                                        <td class="td">{{ ligne.quantite_demande }} {{ ligne.unite.symbole_unite }}</td>
                                        <td class="td" align="right">{{ ligne.prix_unitaire|monetary }} {{ bon.devise.symbole_devise }}</td>
                                        <td class="td" align="right">{{ ligne.total|monetary }} {{ bon.devise.symbole_devise }}</td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                        <div class="col-md-12"><br><br><br></div>
                        <div class="col-md-7"></div>
                        <div class="col-md-5">
                            <table class="no-border total-footer"  style="text-align:right!important;font-size: 16px!important;" width="100%">
                                <tr style="border-top: 1px solid gray!important;">
                                    <td class="no-border" width="45%"><span><strong>Montant HT: </strong></span></td>
                                    <td class="no-border" width="55%"><span>{{ model.montant_ht|monetary }} {{ model.devise.symbole_devise }}</span></td>
                                <tr>
                                <tr>
                                    <td class="no-border" width="45%"><span><strong>Montant Taxe: </strong></span></td>
                                    <td class="no-border" width="55%"><span>{{ model.montant_taxe|monetary }} {{ model.devise.symbole_devise }}</span></td>
                                <tr>
                                <tr>
                                    <td class="no-border" width="45%"><span><strong>Total: </strong></span></td>
                                    <td class="no-border" style="font-size: 18px!important;" width="55%"><span style="border-top: 0.5px solid gray!important;"><strong>{{ model.montant|monetary }} {{ model.devise.symbole_devise }}</strong></span></td>
                                <tr>
                                <tr class="tr-toggle" data-toggle="collapse" data-target=".paiement_id" daria-expanded="false">
                                    <td class="no-border" width="45%"><i class="fa fa-caret-right align-left" style="margin-right: 20px"></i><span>Montant payé: </span></td>
                                    <td class="no-border" width="55%"> <span>{{ model.montant_paye|monetary }} {{ model.devise.symbole_devise }}</span></td>
                                <tr>
                                {% for paiement in paiements %}
                                    <tr class="collapse paiement_id">
                                        <td class="no-border" width="45%">
                                            <a style="font-size: 12px; font-style: italic;" class="lien chargement-au-click" href="{% url 'module_comptabilite_details_paiement_client' paiement.id %}"> Payé le {{ paiement.date_paiement|date:"d/m/Y" }}</a>
                                        </td>
                                        <td style="text-align: right;font-size: 13px;font-style: italic;" width="55%">{{ paiement.montant|monetary }} {{paiement.devise.symbole_devise }}</td>
                                    </tr>
                                {% endfor %}
                                <tr>
                                    <td class="no-border" width="45%"><span><strong>Montant dû: </strong></span></td>
                                    <td class="no-border" style="font-size: 18px!important;" width="55%"><span style="border-top: 0.5px solid gray!important;"><strong>{{ model.montant_restant|monetary }} {{ model.devise.symbole_devise }}</strong><span></td>
                                <tr>
                            </table>
                        </div>
                        <div class="col-md-12"><br><br></div>
                        <div class="col-md-12" >
                            <div class="tabcontrol2" data-role="tabcontrol">
                                <ul class="tabs">
                                    <li class=""><a href="#frame_documents">Documents externes</a></li>
                                </ul>
                                <div class="frames">
                                    <div class="frame" id="frame_documents" style="display: block;">
                                        <div class="row">
                                            {% if documents %}
                                                {% for item in documents %}
                                                    <div class="col-md-2 align-center" >
                                                        <a href="/static{{item.url_document}}" style="text-decoration: none; color: gray;"> <i class="far fa-file-alt" style="font-size: 32px;"></i> <br> <span>{{item.description}} </span>  </a>
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="margin20 no-margin-left no-margin-right">
                                                    <p class="minor-header fg-gray">Aucun document en attache <br></p>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12"><br><br></div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            function imprimer(_id) {
                console.log('mon id '+_id)
                url = '{% url 'module_comptabilite_imprimer_facture_client' %}?ref=' + _id
                newwindow = window.open(url, '', '_blank, height = 9000, width = 9000');
                // newwindow.close();
                //newwindow.#print()
            }
        </script>
        <script>
            $(document).ready(function(){
                $("tr > td > i").removeClass("fa-caret-down");
                $("tr > td > i").addClass("fa-caret-right");
                    $("tr > td > i").data("show", false);

                $(".tr-toggle").click(function() {
                    var icone = $(this).find("i");
                    if (icone.data("show") === true) {
                        icone.removeClass("fa-caret-down");
                        icone.addClass("fa-caret-right");
                        icone.data("show", false);
                    } else {
                        icone.removeClass("fa-caret-right");
                        icone.addClass("fa-caret-down");
                        icone.data("show", true);
                    }
                });
            });
        </script>
    {% endblock %}
