{% extends "ErpProject/ModuleComptabilite/shared/layout.html" %} {% block page %}
    {% load account_filters %}{% load humanize %}
    <div class="row">
        <ul class="breadcrumb">
            <li><a><span class="mif-home"></span></a></li>
            <li><a class="chargement-au-click" href="{% url 'module_comptabilite_tableau_de_bord' %}">Module Comptabilité</a></li>
            <li><a class="chargement-au-click" href="{% url 'module_comptabilite_list_factures_fournisseur' %}">Liste des factures fournisseurs</a></li>
            <li>{{ title }}</li>
        </ul>
    </div>
    
    <div class="row" style="padding-top: 30px;">
        <div class="col-lg-12">
            <h2>{{ title }}</h2> 
            <strong style="float: right;color: grey;opacity: 0.4;margin-top: -30px;">Le {% now " d/m/Y H:i" %}</strong>
            <div class="separ" style="background-color: grey;opacity: 0.2"></div>

            <!-- GESTION DU WORKFLOW -->
            {% include 'ErpProject/ErpBackOffice/widget/workflow.html' with utilisateur=utilisateur model=model content_type_id=content_type_id historique=historique roles=roles etapes_suivantes=etapes_suivantes url_add="module_comptabilite_add_facture_fournisseurs" url_detail="module_comptabilite_details_facture_fournisseur" csrf_token=csrf_token module=module type_doc="Facture fournisseur" only %}  
            <!--FIN GESTION DU WORKFLOW-->     
            
            <div class="separ" style="background-color: grey;opacity: 0.2"></div>
            <br>
            <div class="row">               
                {% if model.est_soldee == False and model.statut_id == 25 %}
                    {% if model.est_mere == True and hasFactureAvoir == False %}
                        <button onclick="javascript:window.location.assign('{% url 'module_comptabilite_add_facture_fournisseur_avance' model.id %}')" class="button small-button rounded primary chargement-au-click">Ajouter Facture d'avance</button>
                        <button onclick="javascript:window.location.assign('{% url 'module_comptabilite_add_paiement_facture_fournisseur' model.id %}')" class="button small-button rounded primary chargement-au-click">Payer la Facture</button>
                        {% if model.est_nullable %}
                        <button onclick="javascript:window.location.assign('{% url 'module_comptabilite_add_facture_avoir' model.id %}')" class="button small-button rounded primary chargement-au-click">Créer Facture d'avoir</button>
                        {% endif %}
                    {% else %} 
                        {% if model.est_facture_avoir != True and hasFactureAvoir == False %}
                            <button onclick="javascript:window.location.assign('{% url 'module_comptabilite_add_paiement_facture_fournisseur' model.id %}')" class="button small-button rounded primary chargement-au-click">Payer la Facture</button>
                        {% endif %}
                    {% endif %}                    
                {% endif %}         
            </div>
            <br>
            <div class="panel panel-default" style="border: none;">                  
                <div class="panel panel-body" style="background-color:white;">
                    <div class="col-md-12">
                        <div class="col-md-6">
                            <h2>{{model.fournisseur.nom_complet}}</h2>
                            <p>Adresse email: <strong>{{model.fournisseur.email}}</strong> <br> Téléphone: <strong>{{model.fournisseur.phone}}</strong>
                            <br>{{model.fournisseur.adresse_complete}}</p>
                            
                        </div>
                        <div class="col-md-6" style="text-align: right;">
                            {% if model.est_mere == True %}
                                {% if model.est_facture_acompte == True %}
                                <h4> <strong style="color: red;">Facture Avance du Fournisseur</strong> </h4>
                                {% else %}
                                <h4> <strong>Facture du fournisseur</strong> </h4>
                                {% endif %}
                            {% else %}
                                {% if model.est_facture_avoir != True %}
                                    <h4> <strong style="color: red;">Facture Avance du Fournisseur</strong> </h4>
                                {% else %}
                                    <h4> <strong style="color: red;">Facture D'avoir</strong> </h4>
                                {% endif %}
                                <h5><strong>Facture du principale : <span style="color: red;"><a href="{% url 'module_comptabilite_details_facture_fournisseur' model.facture_mere.id %}">{{ model.facture_mere.numero_facture }}</a></span></strong></h5>
                            {% endif %}
                            
                            <form  method="POST" action="{% url 'module_achat_bon_reception_print' %}">
                                {% csrf_token %}
                                <input type="hidden" name="id" value={{model.id}}>
                                <!--button type="submit" class="btn btn-default" style="background-color: #41435d;border:none;color: white;" >Imprimer</button-->
                            </form>
                            <button onclick="imprimer({{model.id}})" class="btn btn-default" style="background-color: #41435d;border:none;color: white;" >Imprimer</button>
                            
                            <h3 style="color: red; font-weight: bold">
                                {% if model.numero_facture != None and model.numero_facture != "" %}
                                    <span class="fg-dark">N° {{ model.numero_facture }}</span> 
                                {% else %}
                                    <span class="sub-alt-header fg-dark">N°  --</span> 
                                {% endif %}
                                {% if type_facture == "Bon" %}
                                   <br><span class="sub-alt-header fg-dark">{{model.bon_reception.numero_reception}}</span>
                                {% endif %}            
                            </h3>
                            <br><span style="font-weight: bold"class="fg-dark">N° Séquence {{ model.id }}</span> 
                        </div>
                        <div class="separ col-md-12" style="background-color: grey;opacity: 0.1;margin-bottom: 20px;"></div>
                        <div class="col-md-6" style="margin-bottom: 20px">            
                            <p>                
                                <strong>Date de la facture: </strong>{{model.date_facturation | date:"d/m/Y" }} <br>
                                <strong>Référence facture : </strong>{{model.document}}<br>
                                <strong>Conditions de réglement : </strong>{{model.condition_reglement.designation}}<br>
                                <strong>Nom du client : </strong>ARPCE<br>
                                <strong>Statut de la facture : </strong> {{model.statut.designation}} <br>    
                                {% if type_facture == "Bon" %}                               
                                <strong>Ligne budgetaire : </strong>{{model.bon_reception.ligne_budgetaire.designation}} <br>      
                                {% endif %}   
                                <strong>Autres informations : </strong> {{model.autres_infos}} <br> 
                            </div>                        
                            </p>
                        </div>
                        <div class="col-md-6"></div>                     
                        <div class="col-md-12">
                            <table class="display nowrap border bordered striped" cellspacing="0" style="width: 100%;" >
                                <thead>
                                    <td class="head">Désignation</td>
                                    <td class="head">Quantité</td>
                                    <td class="head">Prix unitaire</td>
                                    <td class="head">Montant</td>
                                </thead>
                                
                                {% for ligne in lignes %}
                                    <tr class="table bordered border">
                                        <td class="td">{{ ligne.nom_article}}</td>
                                        <td class="td">{{ ligne.quantite_demande }} {{ ligne.unite.symbole_unite }}</td>
                                        <td class="td" align="right">{{ ligne.prix_unitaire|monetary }} {{ ligne.devise.symbole_devise }}</td>
                                        <td class="td" align="right">{{ ligne.total|monetary }} {{ ligne.devise.symbole_devise }}</td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                        <div class="col-md-12"><br><br><br></div>
                        <div class="col-md-8"></div>                       
                        <div class="col-md-4">
                            <table class="no-border total-footer"  style="text-align:right!important;font-size: 16px!important;" width="100%">
                                <tr style="border-top: 1px solid gray!important;">
                                    <td class="no-border" width="55%"><span><strong>Montant HT: </strong></span></td>
                                    <td class="no-border" width="45%"><span>{{ model.montant_ht|monetary }} {{ model.devise.symbole_devise }}</span></td>
                                <tr>
                                <tr>
                                    <td class="no-border" width="55%"><span><strong>Montant Taxe: </strong></span></td>
                                    <td class="no-border" width="45%"><span>{{ model.montant_taxe|monetary }} {{ model.devise.symbole_devise }}</span></td>
                                <tr>
                                <tr>
                                    <td class="no-border" width="55%"><span><strong>Total: </strong></span></td>
                                    <td class="no-border" style="font-size: 18px!important;" width="45%"><span style="border-top: 0.5px solid gray!important;"><strong>{{ model.montant|monetary }} {{ model.devise.symbole_devise }}</strong></span></td>
                                <tr>
                                <tr class="tr-toggle" data-toggle="collapse" data-target=".paiement_id" daria-expanded="false">
                                    <td class="no-border" width="55%"><i class="fa fa-caret-right align-left" style="margin-right: 20px"></i><span>Montant payé: </span></td>
                                    <td class="no-border" width="45%"> <span>{{ model.montant_paye|monetary }} {{ model.devise.symbole_devise }}</span></td>
                                <tr>
                                {% for paiement in paiements %}
                                    <tr class="collapse paiement_id"> 
                                        <td class="no-border" width="55%">
                                            <a style="font-size: 12px; font-style: italic;" class="lien chargement-au-click" href="{% url 'module_comptabilite_details_paiement_fournisseur' paiement.id %}"> Payé le {{ paiement.date_paiement|date:"d/m/Y" }}</a>
                                        </td>
                                        <td style="text-align: right;font-size: 13px;font-style: italic;" width="12%">{{ paiement.montant|monetary }} {{paiement.devise.symbole_devise }}</td>
                                    </tr>
                                {% endfor %}
                                <tr>
                                    <td class="no-border" width="55%"><span><strong>Montant dû: </strong></span></td>
                                    <td class="no-border" style="font-size: 18px!important;" width="45%"><span style="border-top: 0.5px solid gray!important;"><strong>{{ model.montant_restant|monetary }} {{ model.devise.symbole_devise }}</strong><span></td>
                                <tr>
                            </table>
                        </div>
                        <div class="col-md-12"><br><br></div>                                                                                  
                        <div class="col-md-12" >
                            <div class="tabcontrol2" data-role="tabcontrol">
                                <ul class="tabs">
                                    <li class="active"><a href="#frame_avances">Factures d'avance</a></li>
                                    <li class=""><a href="#frame_documents">Documents externes</a></li>
                                </ul>
                                <div class="frames">
                                    <div class="frame" id="frame_avances" style="display: block;">
                                        <div class="row">
                                            <div class="col-md-12 margin20 no-margin-left no-margin-right">
                                                {% if factures_filles %}
                                                <br><p class="fg-gray">Liste de factures d'avance: </p>
                                                <table class="table no-margin">
                                                    <thead class="no-border">
                                                        <tr>
                                                            <th width="50%">Numéro</th>
                                                            <th width="50%">Date de la facture</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="items">
                                                    {% for item in factures_filles %}
                                                        <tr class="table bordered border">                                            
                                                            <td>
                                                                <span class="fg-dark"> <a href="{% url 'module_comptabilite_details_facture_fournisseur' item.id %}">{{item.numero_facture}} </a></span>
                                                            </td>
                                                            <td>
                                                                <span class="fg-dark"> {{item.date_facturation | date:"d/m/Y"}} </span>
                                                            </td>
                                                        </tr> 
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                                {% else %}
                                                    <br><p class="fg-gray">Aucune facture d'avance </p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="frame" id="frame_documents" style="display: none;">
                                        <div class="row">
                                            {% if documents %}
                                                {% for item in documents %}
                                                    <div class="col-md-2 align-center" >
                                                        <a href="/static{{item.url_document}}" style="text-decoration: none; color: gray;"> <i class="far fa-file-alt" style="font-size: 32px;"></i> <br> <span>{{item.description}} </span>  </a>
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="margin20 no-margin-left no-margin-right">
                                                    <p class="minor-header fg-gray">Aucun document en attache <br></p>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12"><br><br></div> 
                    </div>
                </div>
            </div>
        </div>
        <script>
            function imprimer(_id) {
                console.log('mon id '+_id)
                url = '{% url 'module_comptabilite_imprimer_facture_fournisseur' %}?ref=' + _id
                newwindow = window.open(url, '', '_blank, height = 9000, width = 9000');
                //newwindow.print()  
            }
        </script>
        <script>
            $(document).ready(function(){
                $("tr > td > i").removeClass("fa-caret-down");
                $("tr > td > i").addClass("fa-caret-right");
                $("tr > td > i").data("show", false);

                $(".tr-toggle").click(function() {
                    var icone = $(this).find("i");
                    if (icone.data("show") === true) {  
                        icone.removeClass("fa-caret-down");
                        icone.addClass("fa-caret-right");
                        icone.data("show", false);                
                    } else {
                        icone.removeClass("fa-caret-right");
                        icone.addClass("fa-caret-down");
                        icone.data("show", true);
                    }
                });	
            });
        </script>
    {% endblock %} 
