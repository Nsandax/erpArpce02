{% extends "ErpProject/ModuleCalendrier/shared/layout.html" %} {% block page %}
    {%load static %}
    {% load account_filters %}
    <div class="row">
        <ul class="breadcrumb">
            <li><a><span class="mif-home"></span></a></li>
            <li><a class="leaf" href="{% url 'module_calendrier_list_evenement' %}">Module Calendrier</a></li>
            <li>{{ title }}</li>
        </ul>
    </div>
    <div class="row" style="">
        <h2>{{title}}</h2>
        <strong style="float: right;color: grey;opacity: 0.4;margin-top: -30px;">{% now "jS F Y H:i" %}</strong>
        <div class="separ" style="background-color: grey;opacity: 0.2"></div>
        <div class="panel panel-body" style="background-color:#f5f5f5;/*border: none;*/border-radius: none;"><br>
            <div class="row">
                <div class="col-md-2">
                    <button style="width: 100%;" onclick="javascript:window.location.assign('{% url 'module_calendrier_add_evenement' %}')" class="theme-btn theme-btn-sm rounded primary_color_{{module.name|lower}} chargement-au-click primary_color_{{ module.name|lower }}">
                        Créer
                    </button>
                </div>
                <div class="col-md-3">
                    <div id="btn-view" data-role="group" data-group-type="one-state">
                        <button id="btn-calendar" onclick="javascript:window.location.assign('{% url 'module_calendrier_list_evenement' %}?view=calendar')" class="button btn-typeview btn-secondary {% if view == "calendar" %}{{ "active" }}{% endif %}"><span class="mif-calendar"></span></button>
                        <button id="btn-tree" onclick="javascript:window.location.assign('{% url 'module_calendrier_list_evenement' %}?view=list')" class="button btn-typeview btn-secondary {% if view == "list" %}{{ "active" }}{% endif %}"><span class="mif-list"></span></button>
                        <button id="btn-kanban" onclick="javascript:window.location.assign('{% url 'module_calendrier_list_evenement' %}?view=kanban')" class="button btn-typeview btn-secondary {% if view == "kanban" %}{{ "active" }}{% endif %}"><span class="mif-apps"></span></button>
                    </div>
                </div>
            </div>
            <hr class="hr-ligne">
            <!-- Appel de la fonction message -->
            {% include 'ErpProject/ErpBackOffice/widget/message.html' with messages=messages only %}

            <!-- Vue de type list -->
            {% if view == "list" %}
                <div id="list-view" class="row" style="margin-top: 10px;">
                    <table id="data_table" class="display nowrap border bordered striped" style="width:100%">
                        <thead>
                            <tr>
                                <th width="2%" style="background-color:#2e416a; white"></th>
                                <th width="25%">Sujet</th>
                                <th width="12%">Date de début</th>
                                <th width="12%">Date de fin</th>
                                <th width="22%">Participants</th>
                                <th width="20%">Lieu</th>
                                <th width="7%">Durée</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in model %}
                                <tr>
                                    <td>
                                        <label class="small-check">
                                            <input type="checkbox">
                                            <span class="check"></span>
                                        </label>
                                    </td>
                                    <td>
                                        <a class="lien chargement-au-click" href="{% url 'module_calendrier_details_evenement' item.id %}">{{ item.designation }}</a>
                                    </td>
                                    <td>
                                        {{item.date_debut|date:'d/m/Y H:i'}}
                                    </td>
                                    <td>
                                        {{item.date_fin|date:'d/m/Y H:i'}}
                                    </td>
                                    <td >
                                        {{item.participants.all|length}} invités
                                    </td>
                                    <td >
                                        {{item.local}}
                                    </td>
                                    <td >
                                        {{item.duree}}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            {% elif view == "kanban" %}
                <!-- Vue de type card -->
                <div id="kanban-view" class="row" style="margin-top: 10px">
                    {% for item in model %}
                    <div class="col-md-4">
                        <div class="card-item" style="margin-top: 10px; margin-bottom: 15px">
                            <div class="card-item-content">
                                <div class="thumb">
                                </div>
                                <div class="texts">
                                    <a class="link chargement-au-click" href="{% url 'module_calendrier_details_evenement' item.id %}">{{ item.designation }}</a><br>
                                    <div class="mt-2"></div>
                                    <span class="inner-text">Du : {{ item.date_debut|date:'d/m/Y H:i' }}</span><br>
                                    <span class="inner-text">Au : {{ item.date_fin|date:'d/m/Y H:i' }}</span><br>
                                    <span class="inner-text">Lieu : {{ item.local }} </span><br>
                                    <span class="inner-text">{{item.participants.all|length}} invités </span>

                                    <a href="{% url 'module_calendrier_details_evenement' item.id %}" class="mt-3 btn btn-block btn-wide rounded chargement-au-click">voir detail</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% elif view == "calendar" %}
                <!-- Vue de type calendrier -->
                <div id="calendar-view" class="row" style="margin-top: 10px">
                    <div class="col-md-9">
                        <div id='calendar'></div>
                    </div>
                    <div class="col-md-3">
                        <div id="calandar_small" class="calendar small" data-role="calendar" data-locale="fr"></div>
                    </div>
                </div>

                <!-- Trigger the modal with a button -->
                <button style="display:none" id="btn-modal" type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#eventModal">Open Modal</button>
                <!-- Modal -->
                <div id="eventModal" class="modal fade" role="dialog">
                    <div class="modal-dialog">
                        <!-- Modal content-->
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Rendez-vous</h4>
                            </div>
                            <div class="modal-body">
                                <div class="event-body">
                                    <div class="event-section">
                                        <div class="event-icons">
                                            <i class="fg-green fa fa-square"></i>
                                        </div>
                                        <div class="title-event-section">
                                            <span id="event-title" role="heading" aria-level="1"></span>
                                            <br>
                                            <p class="subtitle-event-section">
                                                <span id="event-date_debut"></span><span class="amqcKf">⋅</span><span id="event-heure_debut_fin"></span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="event-section">
                                        <div class="event-icons">
                                            <i class="fg-gray fas fa-map-marker-alt"></i>
                                        </div>
                                        <div class="subtitle-event-section">
                                            <span id="event-local"></span>
                                        </div>
                                    </div>
                                    <div class="event-section">
                                        <div class="event-icons">
                                            <i class="fg-gray fa fa-users"></i>
                                        </div>
                                        <div class="subtitle-event-section">
                                            <span id="event-nbre_invites"></span> <a href="#" style="margin-left:20px;"><i id="fa-caret" data-show="false" class="fa"></i></a>
                                        </div>
                                    </div>
                                    <div id="invites-section" class="event-section">
                                        <div class="event-icons">
                                        </div>
                                        <div class="subtitle-event-section">
                                            <table id="id_participants" class="no-bordered" style="width:100%">

                                            </table>
                                        </div>
                                    </div>
                                    <div class="event-section">
                                        <div class="event-icons">
                                            <i class="fg-gray fas fa-bars"></i>
                                        </div>
                                        <div class="subtitle-event-section">
                                            <span id="event-description"></span>
                                        </div>
                                    </div>
                                    <div class="event-section">
                                        <div class="event-icons">
                                            <i class="fg-gray far fa-bell"></i>
                                        </div>
                                        <div class="subtitle-event-section">
                                            <span id="event-alarmes"></span>
                                        </div>
                                    </div>
                                    <div class="event-section">
                                        <div class="event-icons">
                                            <i class="fg-gray far fa-calendar-alt"></i>
                                        </div>
                                        <div class="subtitle-event-section">
                                            <span id="event-proprietaires"></span>
                                            <br><span id="event-auteur"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <!-- Button dropdown -->
                                <button class="theme-btn-dropdown dropdown theme-btn theme-btn-sm rounded chargement-au-click" >
                                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                                        <i class="fa fa-circle fg-green"></i> Acceptée
                                    </a>
                                    <ul class="dropdown-menu dropdown-user">
                                        <li><a href="#" id="btn_accept" class="dropdown-item"> <i class="fa fa-circle fg-green"></i> Accepter </a></li>
                                        <li><a href="#" id="btn_decline" class="dropdown-item"> <i class="fa fa-circle fg-red"></i> Refuser </a></li>
                                        <li><a href="#" id="btn_maybe" class="dropdown-item"> <i class="fa fa-circle fg-gray"></i> Incertain </a></li>
                                    </ul>
                                </button>
                                <!-- /.Button dropdown -->
                                <button type="button" class="theme-btn theme-btn-sm rounded chargement-au-click" data-dismiss="modal">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    <!-- Appel widget datatable -->
    {% include 'ErpProject/ErpBackOffice/widget/datatable.html' with type_view=view %}
    <script>
        $(document).ready(function() {
            // Gestion liste calendrier
            var lesEvenements = new Array();
            {% if view == "calendar" %}
                /*$("component_id").calendar({
                    format: string, //default 'yyyy-mm-dd'
                    multiSelect: boolean, //default true (multi select date)
                    startMode: 'day', //year, month, day
                    date: string, //the init calendar date (example: '2013-01-01' or '2012-01')
                    locale: 'en', // 'ru', 'ua', 'fr' or 'en', default is $.Metro.currentLocale
                    otherDays: false, // show days for previous and next months,
                    weekStart: 0, //start week from sunday - 0 or monday - 1
                    getDates: function(d){...}, // see example below
                    click: function(d){...}, // fired when user clicked on day, in "d" stored date
                });*/

                $("#calandar_small .button.warning").hide();
                $("#calandar_small .button.success").hide();

                var calendarEl = document.getElementById('calendar');
                // Gestion liste calendrier
                var lesEvenements = new Array();
                {% if view == "calendar" %}
                    {% for item in model %}
                        var participants = new Array();
                        {% for participant in item.participants.all %}
                            participants.push({nom_participant:"{{ participant.nom_participant }}", email_participant:"{{ participant.email_participant }}"});
                        {% endfor %}

                        var proprietaires = "";
                        {% for proprietaire in item.proprietaires.all %}
                            proprietaires += "{{ proprietaire.nom_complet }} ,"
                        {% endfor %}
                        proprietaires = proprietaires.slice(0, -1);

                        var alarmes = "";
                        {% for alarme in item.rappels.all %}
                            alarmes += "{{ alarme.designation }} ,"
                        {% endfor %}
                        alarmes = alarmes.slice(0, -1);
                        eventObject = {id:parseInt("{{ item.id }}"), title:"{{ item.designation }}", start:"{{ item.date_debut|date:'Y-m-d' }}T{{ item.date_debut|date:'H:i:00' }}", end:"{{ item.date_fin|date:'Y-m-d' }}T{{ item.date_fin|date:'H:i:00' }}",
                                        groupId:parseInt("{{ item.recurrent_id }}"), date_debut:"{{ item.date_debut|date:'Y-m-d' }}", heure_debut_fin:"{{ item.date_debut|date:'H:i' }} - {{ item.date_fin|date:'H:i' }}",
                                        nbre_invites:"{{item.participants.all|length}} invités", local:"{{item.local.designation}}", description:"{{item.description}}", auteur:"Créé par {{item.auteur.nom_complet}}",
                                        participants: participants, proprietaires: proprietaires, alarmes:alarmes};
                        lesEvenements.push(eventObject);
                    {% endfor %}
                {% endif %}
                //console.log(lesEvenements);
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    plugins: [ 'interaction', 'dayGrid', 'timeGrid', 'list' ],
                    header: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                    },
                    defaultDate: "{% now 'Y-m-d' %}",
                    locale: 'fr',
                    buttonIcons: false, // show the prev/next text
                    weekNumbers: true,
                    navLinks: true, // can click day/week names to navigate views
                    editable: false,
                    eventClick: function(info) {
                        var levenement = lesEvenements.find(function(evenement, index) {
                            if(parseInt(evenement.id) == parseInt(info.event.id))
                                return true;
                        });
                        console.log(levenement);

                        //console.log('Event: ' + info.event.title);
                        //alert('Coordinates: ' + info.jsEvent.pageX + ',' + info.jsEvent.pageY);
                        //alert('View: ' + info.view.type);
                        //$('#eventModal').modal('toggle');
                        // change the border color just for fun
                        //info.el.style.borderColor = 'red';

                        $("#fa-caret").removeClass("fa-caret-up");
                        $("#fa-caret").addClass("fa-caret-down");
                        $("#fa-caret").data("show", false);

                        $("#invites-section").hide();

                        //Gestion participant
                        $("#fa-caret").click(function() {
                            if ($("#fa-caret").data("show") === true) {
                                $("#fa-caret").removeClass("fa-caret-up");
                                $("#fa-caret").addClass("fa-caret-down");
                                $("#fa-caret").data("show", false);

                                $("#invites-section").hide();
                            } else {
                                $("#fa-caret").removeClass("fa-caret-down");
                                $("#fa-caret").addClass("fa-caret-up");
                                $("#fa-caret").data("show", true);

                                $("#invites-section").show();
                            }
                        });

                        $("#event-title").text(levenement.title);
                        $("#event-date_debut").text(levenement.date_debut);
                        $("#event-heure_debut_fin").text(levenement.heure_debut_fin);
                        $("#event-nbre_invites").text(levenement.nbre_invites);
                        $("#event-local").text(levenement.local);
                        $("#event-description").text(levenement.description);
                        $("#event-alarmes").text(levenement.alarmes);
                        $("#event-auteur").text(levenement.auteur);
                        $("#event-proprietaires").text(levenement.proprietaires);

                        $("#id_participants").empty();
                        var lesparticipants = levenement.participants;

                        for(var i = 0; i < lesparticipants.length; i++) {
                            var participant = lesparticipants[i];
                            var nouvelleLigne = "";
                            nouvelleLigne += '<tr><td width="7%"><i class="fg-gray fa fa-user-circle" style="font-size:20px;"></i></td>';
                            nouvelleLigne += '<td width="93%" class="align-left"><span>' + participant.nom_participant +'</span></td></tr>';
                            $("#id_participants").append(nouvelleLigne);
                        }
                        document.getElementById('btn-modal').click();

                    },
                    eventLimit: true, // allow "more" link when too many events
                    events: lesEvenements,
                });
                calendar.render();
            {% endif %}

        });

    </script>
{% endblock %}